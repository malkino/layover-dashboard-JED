
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Layover Dashboard</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCr4bOp9yTBb8rAxMhrvI-B4NuLklv3Cqs",
      authDomain: "layover-dashboard.firebaseapp.com",
      databaseURL: "https://layover-dashboard-default-rtdb.firebaseio.com",
      projectId: "layover-dashboard",
      storageBucket: "layover-dashboard.firebasestorage.app",
      messagingSenderId: "507835036271",
      appId: "1:507835036271:web:6b29e7d79c656d5ec1939a",
      measurementId: "G-DXHZRFNJPV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase();

    const buildings = [1, 2, 14, 15];
    const floors = { 1: ['A','B','C','D'], 2: ['E','F','G','H'], 3: ['J','L','K','I'] };
    const rooms = ['S', 'D'];
    const bedsPerRoom = 2;

    if (localStorage.getItem("loggedIn") !== "true") {
      window.location.href = "login.html";
    }

    function updateDateTime() {
      const now = new Date();
      document.getElementById("datetime").innerText = now.toLocaleString();
    }

    window.logout = function() {
      localStorage.removeItem("loggedIn");
      window.location.href = "login.html";
    }

    window.printReport = function() {
      window.print();
    }

    function renderBeds(data) {
      const selected = document.getElementById("buildingFilter").value;
      const dashboard = document.getElementById("dashboard");
      dashboard.innerHTML = "";

      let total = 0, occupied = 0;

      buildings.forEach(building => {
        if (selected !== "all" && selected != building) return;

        const section = document.createElement("div");
        section.innerHTML = `<h3>Building ${building}</h3>`;
        for (let floor = 1; floor <= 3; floor++) {
          floors[floor].forEach(apt => {
            const aptLabel = document.createElement("div");
            aptLabel.innerHTML = `<strong>Apt ${apt}:</strong><br>`;
            rooms.forEach(room => {
              for (let bed = 1; bed <= bedsPerRoom; bed++) {
                const key = `${building}-${apt}-${room}-${bed}`;
                const info = data[key] || { occupied: false, crew: "" };
                const div = document.createElement("div");
                div.className = info.occupied ? "bed occupied" : "bed";
                div.textContent = `${room}-${bed}`;
                div.onclick = (e) => {
                  if (e.target.tagName !== 'INPUT') {
                    info.occupied = !info.occupied;
                    update(ref(db, "beds/" + key), { occupied: info.occupied });
                  }
                };
                const input = document.createElement("input");
                input.type = "text";
                input.placeholder = "Crew ID";
                input.maxLength = 8;
                input.value = info.crew || "";
                
let timer;
input.oninput = () => {
  clearTimeout(timer);
  timer = setTimeout(() => {
    update(ref(db, "beds/" + key), { crew: input.value });
  }, 500);
};

                div.appendChild(document.createElement("br"));
                div.appendChild(input);
                aptLabel.appendChild(div);
                total++;
                if (info.occupied) occupied++;
              }
            });
            section.appendChild(aptLabel);
          });
        }
        dashboard.appendChild(section);
      });

      document.getElementById("totalBeds").innerText = total;
      document.getElementById("occupiedBeds").innerText = occupied;
      document.getElementById("vacantBeds").innerText = total - occupied;
    }

    window.onload = function () {
      updateDateTime();
      setInterval(updateDateTime, 60000);

      const bedsRef = ref(db, "beds");
      onValue(bedsRef, (snapshot) => {
        const data = snapshot.val() || {};
        renderBeds(data);
      });
    }
  </script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f9f9f9; }
    header { background-color: #004d40; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    main { padding: 1rem; }
    .logout { background-color: red; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
    .filters, .status-bar { margin-bottom: 1rem; display: flex; gap: 10px; flex-wrap: wrap; }
    .bed { display: inline-block; margin: 5px; padding: 10px; border-radius: 6px; width: 130px; background: #4caf50; color: white; cursor: pointer; text-align: center; }
    .occupied { background: #f44336 !important; }
    input[type="text"] { width: 100px; padding: 4px; margin-top: 5px; text-align: center; }
    .status-box { background: #e0f2f1; color: #004d40; padding: 10px; border-radius: 6px; }
  </style>
</head>
<body>
  <header>
    <div><strong>Housing and Welfare</strong> | <span id="datetime"></span></div>
    <button class="logout" onclick="logout()">Logout</button>
  </header>
  <main>
    <div class="filters">
      <label>Filter Building:</label>
      <select id="buildingFilter" onchange="location.reload()">
        <option value="all">All</option>
        <option value="1">Building 1</option>
        <option value="2">Building 2</option>
        <option value="14">Building 14</option>
        <option value="15">Building 15</option>
      </select>
      <button onclick="printReport()">üñ®Ô∏è Print Report</button>
    </div>
    <div class="status-bar">
      <div class="status-box">Total Beds: <span id="totalBeds">0</span></div>
      <div class="status-box">Occupied: <span id="occupiedBeds">0</span></div>
      <div class="status-box">Vacant: <span id="vacantBeds">0</span></div>
    </div>
    <div id="dashboard"></div>
  </main>
</body>
</html>
